FROM Base.img

# Step 1: Install libisl in the version needed by nexmon
WORKDIR /broadcast-tree/nexmon/buildtools/isl-0.10
RUN ./configure
RUN make -j $(( $(nproc) + 1 ))
RUN make install
RUN ln -s -f /usr/local/lib/libisl.so /usr/lib/arm-linux-gnueabihf/libisl.so.10

# Step 2: Install libmpfr in the version needed by nexmon
WORKDIR /broadcast-tree/nexmon/buildtools/mpfr-3.1.4
RUN autoreconf -f -i
RUN ./configure
RUN make -j $(( $(nproc) + 1 ))
RUN make install
RUN ln -f -s /usr/local/lib/libmpfr.so /usr/lib/arm-linux-gnueabihf/libmpfr.so.4

# Step 3: Prepare the toolchain for nexmon patches
WORKDIR /broadcast-tree/nexmon
RUN bash -c "
    source /broadcast-tree/nexmon/setup_env.sh
    make
"

# Step 4: Install the nexmon BTP patch
RUN cp -r /broadcast-tree/btp/nexmon_patch /broadcast-tree/nexmon/patches/bcm43430a1/7_45_41_46/btp/
WORKDIR /broadcast-tree/nexmon/patches/bcm43430a1/7_45_41_46/btp/
RUN bash -c "
    source /broadcast-tree/nexmon/setup_env.sh
    make
"

# Step 5: Install BTP
WORKDIR /broadcast-tree/btp
RUN make
RUN install -D -m 755 btp /usr/local/bin/btp
