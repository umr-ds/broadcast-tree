<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/@hpcc-js/wasm@1.14.1/dist/index.min.js"></script>
<script src="https://unpkg.com/d3-graphviz@4.1.1/build/d3-graphviz.js"></script>

<button onclick="run_button(true)">Play</button>
<button onclick="run_button(false)">Pause</button>

<button onclick="step_button(-1)">Back</button>
<button onclick="step_button(1)">Step</button>

<form id="step_form">
    Step: <input type="number" name="step" id="step_value">
</form>
<button onclick="set_step()">Jump</button>

<div id="graph" style="text-align: center;"></div>

<script>
var running = false;
var dotIndex = 0;

function set_step() {
    if (running) {
        return;
    }
    dotIndex = document.getElementById("step_value").value;
    render()
}

function run_button(state) {
    running = state;

    if (running) {
        render();
    }
}

function step_button(direction) {
    dotIndex = (((dotIndex + direction) % dots.length) + dots.length) % dots.length;
    render();
}

var graphviz = d3.select("#graph").graphviz()
    .transition(function () {
        return d3.transition("main")
            .ease(d3.easeLinear)
            .delay(100)
            .duration(100);
    })
    .logEvents(true)
    .on("initEnd", render);

function render() {
    var dot = dots[dotIndex];
    graphviz
        .renderDot(dot)
        .on("end", function () {
            if (running) {
                dotIndex = (dotIndex + 1) % dots.length;
                if (dotIndex == dots.length - 1) {
                    running = false;
                }
                render();
            }
        });
}

var dots = [
    {graph_series}
];

</script>
